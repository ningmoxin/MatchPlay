<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è³‡æ–™å·¥å…· - MatchPlay</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>ğŸ”§ è³‡æ–™å·¥å…·</h1>
      <p class="subtitle">ç®¡ç†åƒèˆ‡è€…é †åº</p>
    </header>

    <div class="card">
      <h2>ğŸ“‹ æ’å…¥åƒèˆ‡è€…</h2>
      <p style="color: #666; margin-bottom: 20px;">åœ¨æŒ‡å®šä½ç½®æ’å…¥æ–°åƒèˆ‡è€…ï¼Œå¾Œé¢çš„äººæœƒè‡ªå‹•å¾€å¾Œç§»</p>

      <div class="form-group">
        <label>æ’å…¥ä½ç½® (order)</label>
        <input type="number" id="insert-position" class="form-control" value="7" min="1">
      </div>

      <div class="form-group">
        <label>æ–°åƒèˆ‡è€…å§“å</label>
        <input type="text" id="insert-name" class="form-control" placeholder="è¼¸å…¥å§“å">
      </div>

      <button id="insert-btn" class="btn btn-primary btn-block">æ’å…¥åƒèˆ‡è€…</button>
    </div>

    <div class="card">
      <h2>ğŸ“Š ç›®å‰åƒèˆ‡è€…åˆ—è¡¨</h2>
      <ul id="participant-list" class="participant-list">
        <li>è¼‰å…¥ä¸­...</li>
      </ul>
      <button id="refresh-btn" class="btn btn-secondary" style="margin-top: 15px;">é‡æ–°æ•´ç†</button>
    </div>

    <div class="card">
      <h2>ğŸ”„ é‡æ–°æ’åº</h2>
      <p style="color: #666; margin-bottom: 20px;">æŒ‰ç…§ç›®å‰é †åºé‡æ–°ç·¨è™Ÿ (1, 2, 3...)</p>
      <button id="reorder-btn" class="btn btn-gold btn-block">é‡æ–°æ’åº</button>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <a href="admin.html" class="btn btn-secondary">â† è¿”å›ç®¡ç†é </a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase-config.js"></script>

  <script>
    const participantList = document.getElementById('participant-list');
    const insertBtn = document.getElementById('insert-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const reorderBtn = document.getElementById('reorder-btn');
    const insertPosition = document.getElementById('insert-position');
    const insertName = document.getElementById('insert-name');

    // è¼‰å…¥åƒèˆ‡è€…åˆ—è¡¨
    async function loadParticipants() {
      participantList.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';

      const snapshot = await database.ref('participants').once('value');
      const data = snapshot.val() || {};

      const participants = Object.entries(data)
        .map(([id, val]) => ({ id, ...val }))
        .sort((a, b) => a.order - b.order);

      if (participants.length === 0) {
        participantList.innerHTML = '<li class="empty-state"><p>å°šç„¡åƒèˆ‡è€…</p></li>';
        return;
      }

      participantList.innerHTML = participants.map(p => `
        <li class="participant-item">
          <span><strong>${p.order}.</strong> ${p.name}</span>
          <span style="color: #999; font-size: 0.8rem;">${p.id.substring(0, 8)}...</span>
        </li>
      `).join('');
    }

    // æ’å…¥åƒèˆ‡è€…
    async function insertParticipant() {
      const position = parseInt(insertPosition.value);
      const name = insertName.value.trim();

      if (!name) {
        showToast('è«‹è¼¸å…¥å§“å');
        return;
      }

      if (position < 1) {
        showToast('ä½ç½®å¿…é ˆå¤§æ–¼ 0');
        return;
      }

      insertBtn.disabled = true;
      insertBtn.textContent = 'è™•ç†ä¸­...';

      try {
        // å–å¾—æ‰€æœ‰åƒèˆ‡è€…
        const snapshot = await database.ref('participants').once('value');
        const data = snapshot.val() || {};

        // æŠŠ position ä»¥å¾Œçš„éƒ½å¾€å¾Œç§»ä¸€ä½
        const updates = {};
        Object.entries(data).forEach(([id, participant]) => {
          if (participant.order >= position) {
            updates[`${id}/order`] = participant.order + 1;
          }
        });

        // æ›´æ–°ç¾æœ‰é †åº
        if (Object.keys(updates).length > 0) {
          await database.ref('participants').update(updates);
        }

        // æ–°å¢æ–°åƒèˆ‡è€…
        const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
        await database.ref('participants').child(newId).set({
          name: name,
          order: position
        });

        showToast(`å·²åœ¨ä½ç½® ${position} æ’å…¥ã€Œ${name}ã€`);
        insertName.value = '';
        loadParticipants();

      } catch (error) {
        console.error(error);
        showToast('æ“ä½œå¤±æ•—: ' + error.message);
      } finally {
        insertBtn.disabled = false;
        insertBtn.textContent = 'æ’å…¥åƒèˆ‡è€…';
      }
    }

    // é‡æ–°æ’åº
    async function reorderParticipants() {
      reorderBtn.disabled = true;
      reorderBtn.textContent = 'è™•ç†ä¸­...';

      try {
        const snapshot = await database.ref('participants').once('value');
        const data = snapshot.val() || {};

        const participants = Object.entries(data)
          .map(([id, val]) => ({ id, ...val }))
          .sort((a, b) => a.order - b.order);

        const updates = {};
        participants.forEach((p, index) => {
          updates[`${p.id}/order`] = index + 1;
        });

        await database.ref('participants').update(updates);

        showToast('å·²é‡æ–°æ’åº');
        loadParticipants();

      } catch (error) {
        console.error(error);
        showToast('æ“ä½œå¤±æ•—: ' + error.message);
      } finally {
        reorderBtn.disabled = false;
        reorderBtn.textContent = 'é‡æ–°æ’åº';
      }
    }

    // äº‹ä»¶ç¶å®š
    insertBtn.addEventListener('click', insertParticipant);
    refreshBtn.addEventListener('click', loadParticipants);
    reorderBtn.addEventListener('click', reorderParticipants);

    insertName.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') insertParticipant();
    });

    // åˆå§‹åŒ–
    loadParticipants();
    createSnowflakes();
  </script>
</body>
</html>
