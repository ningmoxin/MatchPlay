<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ä»‹é¢ - MatchPlay</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- å¯†ç¢¼é©—è­‰å½ˆçª— -->
  <div id="password-modal" class="password-modal">
    <div class="modal-content">
      <h3>ğŸ” ç®¡ç†è€…ç™»å…¥</h3>
      <div class="form-group">
        <label for="password-input">è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼</label>
        <input type="password" id="password-input" class="form-control" placeholder="å¯†ç¢¼">
      </div>
      <p id="password-error" class="error hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>
      <button id="login-btn" class="btn btn-primary btn-block">ç™»å…¥</button>
      <a href="index.html" style="display: block; text-align: center; margin-top: 15px; color: #666;">è¿”å›é¦–é </a>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div id="admin-content" class="hidden">
    <!-- å°èˆªåˆ— -->
    <nav class="nav-bar">
      <a href="index.html">â† è¿”å›é¦–é </a>
      <span>ç®¡ç†ä»‹é¢</span>
      <a href="#" id="logout-btn">ç™»å‡º</a>
    </nav>

    <div class="container">
      <!-- ç‹€æ…‹é¡¯ç¤º -->
      <div class="card">
        <h2>ğŸ“Š ç›®å‰ç‹€æ…‹</h2>
        <div id="status-display">
          <span class="status-badge status-waiting">â³ ç­‰å¾…ä¸­</span>
        </div>
      </div>

      <!-- åƒèˆ‡è€…åå–® -->
      <div class="card">
        <h2>ğŸ“‹ åƒèˆ‡è€…åå–® (<span id="participant-count">0</span> äºº)</h2>

        <div class="add-participant">
          <input type="text" id="new-participant" class="form-control" placeholder="è¼¸å…¥åƒèˆ‡è€…å§“å">
          <button id="add-participant-btn" class="btn btn-primary">æ–°å¢</button>
        </div>

        <ul id="participant-list" class="participant-list">
          <li class="empty-state">
            <div class="icon">ğŸ‘¥</div>
            <p>å°šç„¡åƒèˆ‡è€…</p>
          </li>
        </ul>
      </div>

      <!-- å‹•ç•«è¨­å®š -->
      <div class="card">
        <h2>âš™ï¸ å‹•ç•«è¨­å®š</h2>
        <div class="form-group">
          <label>åå­—æ»¾å‹•æ¬¡æ•¸ (æ¬¡)</label>
          <input type="number" id="roll-count" class="form-control" value="15" min="8" max="30" step="1">
          <small style="color: #888;">å»ºè­° 12-20 æ¬¡ï¼Œæ•¸å­—è¶Šå¤§å‹•ç•«è¶Šé•·</small>
        </div>
        <div class="form-group">
          <label>æ­æ›‰é–“éš” (ç§’) - ç¬¬ä¸€äººæ­æ›‰å¾Œç­‰å¾…å¤šä¹…æ­æ›‰ç¬¬äºŒäºº</label>
          <input type="number" id="reveal-delay" class="form-control" value="1" min="0.5" max="5" step="0.5">
        </div>
        <button id="save-settings-btn" class="btn btn-secondary">ğŸ’¾ å„²å­˜è¨­å®š</button>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="card">
        <h2>ğŸ® æ“ä½œæ§åˆ¶</h2>
        <div class="control-panel">
          <button id="start-pairing-btn" class="btn btn-gold btn-lg">ğŸ² é–‹å§‹é…å°</button>
          <button id="reset-btn" class="btn btn-danger">ğŸ”„ é‡ç½®é…å°</button>
        </div>
        <p id="pairing-hint" style="margin-top: 15px; color: #666; font-size: 0.9rem;"></p>
      </div>

      <!-- é…å°çµæœ -->
      <div class="card" id="pairs-section">
        <h2>ğŸ é…å°çµæœ</h2>

        <div class="progress-bar">
          <div id="reveal-progress" class="progress" style="width: 0%"></div>
        </div>
        <p id="progress-text" style="text-align: center; color: #666; margin-bottom: 20px;">å°šæœªé…å°</p>

        <ul id="pairs-list" class="pair-list">
          <!-- é…å°é …ç›®æœƒå‹•æ…‹è¼‰å…¥ -->
        </ul>

        <div style="margin-top: 20px; text-align: center;">
          <button id="reveal-next-btn" class="btn btn-primary btn-lg hidden">ğŸ æ­æ›‰ä¸‹ä¸€çµ„</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- å…±ç”¨è¨­å®š -->
  <script src="js/firebase-config.js"></script>

  <script>
    // ç‹€æ…‹
    let isLoggedIn = false;
    let currentParticipants = [];
    let currentPairs = [];
    let currentGameState = { status: 'waiting', currentPairIndex: 0 };

    // DOM å…ƒç´ 
    const passwordModal = document.getElementById('password-modal');
    const adminContent = document.getElementById('admin-content');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const participantList = document.getElementById('participant-list');
    const participantCount = document.getElementById('participant-count');
    const newParticipantInput = document.getElementById('new-participant');
    const addParticipantBtn = document.getElementById('add-participant-btn');

    const statusDisplay = document.getElementById('status-display');
    const startPairingBtn = document.getElementById('start-pairing-btn');
    const resetBtn = document.getElementById('reset-btn');
    const pairingHint = document.getElementById('pairing-hint');

    const pairsList = document.getElementById('pairs-list');
    const revealProgress = document.getElementById('reveal-progress');
    const progressText = document.getElementById('progress-text');
    const revealNextBtn = document.getElementById('reveal-next-btn');

    // === ç™»å…¥/ç™»å‡º ===
    function login() {
      const password = passwordInput.value;

      if (verifyPassword(password)) {
        isLoggedIn = true;
        passwordModal.classList.add('hidden');
        adminContent.classList.remove('hidden');
        sessionStorage.setItem('adminLoggedIn', 'true');
        initAdmin();
      } else {
        passwordError.classList.remove('hidden');
        passwordInput.value = '';
        passwordInput.focus();
      }
    }

    function logout() {
      isLoggedIn = false;
      sessionStorage.removeItem('adminLoggedIn');
      passwordModal.classList.remove('hidden');
      adminContent.classList.add('hidden');
      passwordInput.value = '';
      passwordError.classList.add('hidden');
    }

    function checkSession() {
      if (sessionStorage.getItem('adminLoggedIn') === 'true') {
        isLoggedIn = true;
        passwordModal.classList.add('hidden');
        adminContent.classList.remove('hidden');
        initAdmin();
      }
    }

    // === åƒèˆ‡è€…ç®¡ç† ===
    function renderParticipants(participants) {
      currentParticipants = participants;
      participantCount.textContent = participants.length;

      if (participants.length === 0) {
        participantList.innerHTML = `
          <li class="empty-state">
            <div class="icon">ğŸ‘¥</div>
            <p>å°šç„¡åƒèˆ‡è€…</p>
          </li>
        `;
        return;
      }

      participantList.innerHTML = participants.map((p, index) => `
        <li class="participant-item" data-id="${p.id}">
          <span class="participant-name">${index + 1}. ${escapeHtml(p.name)}</span>
          <div class="participant-actions">
            <button class="btn btn-icon btn-secondary edit-btn" title="ç·¨è¼¯">âœï¸</button>
            <button class="btn btn-icon btn-danger delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button>
          </div>
        </li>
      `).join('');

      // ç¶å®šäº‹ä»¶
      participantList.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', handleEditParticipant);
      });

      participantList.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteParticipant);
      });

      updatePairingHint();
    }

    async function handleAddParticipant() {
      const name = newParticipantInput.value.trim();
      if (!name) {
        showToast('è«‹è¼¸å…¥åƒèˆ‡è€…å§“å');
        return;
      }

      // æª¢æŸ¥é‡è¤‡
      if (currentParticipants.some(p => p.name === name)) {
        showToast('æ­¤å§“åå·²å­˜åœ¨');
        return;
      }

      try {
        await addParticipant(name);
        newParticipantInput.value = '';
        showToast('å·²æ–°å¢åƒèˆ‡è€…');
      } catch (error) {
        console.error(error);
        showToast('æ–°å¢å¤±æ•—');
      }
    }

    async function handleEditParticipant(e) {
      const item = e.target.closest('.participant-item');
      const id = item.dataset.id;
      const participant = currentParticipants.find(p => p.id === id);

      const newName = prompt('ç·¨è¼¯åƒèˆ‡è€…å§“åï¼š', participant.name);
      if (newName && newName.trim() && newName !== participant.name) {
        try {
          await updateParticipant(id, newName.trim());
          showToast('å·²æ›´æ–°');
        } catch (error) {
          console.error(error);
          showToast('æ›´æ–°å¤±æ•—');
        }
      }
    }

    async function handleDeleteParticipant(e) {
      const item = e.target.closest('.participant-item');
      const id = item.dataset.id;
      const participant = currentParticipants.find(p => p.id === id);

      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${participant.name}ã€å—ï¼Ÿ`)) {
        try {
          await deleteParticipant(id);
          showToast('å·²åˆªé™¤');
        } catch (error) {
          console.error(error);
          showToast('åˆªé™¤å¤±æ•—');
        }
      }
    }

    // === ç‹€æ…‹é¡¯ç¤º ===
    function updateStatusDisplay(state) {
      currentGameState = state;

      const statusMap = {
        'waiting': { text: 'ç­‰å¾…ä¸­', class: 'status-waiting', icon: 'â³' },
        'pairing': { text: 'é…å°ä¸­', class: 'status-pairing', icon: 'ğŸ”„' },
        'revealing': { text: 'æ­æ›‰ä¸­', class: 'status-revealing', icon: 'ğŸ' },
        'finished': { text: 'å·²å®Œæˆ', class: 'status-finished', icon: 'âœ…' }
      };

      const status = statusMap[state.status] || statusMap['waiting'];

      statusDisplay.innerHTML = `
        <span class="status-badge ${status.class}">
          ${status.icon} ${status.text}
        </span>
      `;

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      updateButtonStates();
    }

    function updateButtonStates() {
      const state = currentGameState.status;
      const count = currentParticipants.length;

      // é–‹å§‹é…å°æŒ‰éˆ•ï¼ˆç¾åœ¨æ”¯æ´å¥‡æ•¸äººæ•¸ï¼‰
      startPairingBtn.disabled = state !== 'waiting' || count < 2;

      // æ­æ›‰æŒ‰éˆ•
      if (state === 'revealing') {
        revealNextBtn.classList.remove('hidden');
      } else {
        revealNextBtn.classList.add('hidden');
      }

      // é‡ç½®æŒ‰éˆ•
      resetBtn.disabled = state === 'waiting' && currentPairs.length === 0;

      updatePairingHint();
    }

    function updatePairingHint() {
      const count = currentParticipants.length;

      if (count === 0) {
        pairingHint.textContent = 'è«‹å…ˆæ–°å¢åƒèˆ‡è€…';
      } else if (count === 1) {
        pairingHint.textContent = 'è‡³å°‘éœ€è¦ 2 ä½åƒèˆ‡è€…';
      } else if (count % 2 !== 0) {
        const pairCount = Math.floor(count / 2);
        pairingHint.textContent = `ç›®å‰ ${count} äººï¼ˆå¥‡æ•¸ï¼‰ï¼Œå°‡ç”¢ç”Ÿ ${pairCount - 1} çµ„å…©äººé…å° + 1 çµ„ä¸‰äººé…å°`;
      } else {
        pairingHint.textContent = `ç›®å‰ ${count} äººï¼Œå¯ç”¢ç”Ÿ ${count / 2} çµ„é…å°`;
      }
    }

    // === é…å°ç®¡ç† ===
    function renderPairs(pairs) {
      currentPairs = pairs;

      if (pairs.length === 0) {
        pairsList.innerHTML = `
          <li class="empty-state">
            <div class="icon">ğŸ</div>
            <p>å°šæœªé€²è¡Œé…å°</p>
          </li>
        `;
        progressText.textContent = 'å°šæœªé…å°';
        revealProgress.style.width = '0%';
        return;
      }

      // åªè¨ˆç®—å‹•ç•«å·²å®Œæˆçš„é…å°
      const completedCount = pairs.filter(p => p.animationComplete).length;
      const totalCount = pairs.length;
      const progress = (completedCount / totalCount) * 100;

      revealProgress.style.width = progress + '%';
      progressText.textContent = `å·²æ­æ›‰ ${completedCount} / ${totalCount} çµ„`;

      pairsList.innerHTML = pairs.map((pair, index) => {
        let pairDisplay = `ç¬¬ ${index + 1} çµ„`;
        let statusBadge = 'ğŸ”’ æœªæ­æ›‰';
        let statusClass = 'status-waiting';
        let itemClass = '';

        // åªæœ‰ç•¶å‹•ç•«å®Œæˆå¾Œæ‰é¡¯ç¤ºåå­—
        if (pair.animationComplete) {
          if (pair.isTriple) {
            pairDisplay = `${escapeHtml(pair.person1Name)} <span class="arrow">â†”</span> ${escapeHtml(pair.person2Name)} <span class="arrow">â†”</span> ${escapeHtml(pair.person3Name)}`;
          } else {
            pairDisplay = `${escapeHtml(pair.person1Name)} <span class="arrow">â†”</span> ${escapeHtml(pair.person2Name)}`;
          }
          statusBadge = 'âœ… å·²æ­æ›‰';
          statusClass = 'status-finished';
          itemClass = 'revealed';
        } else if (pair.revealed) {
          // å‹•ç•«é€²è¡Œä¸­
          pairDisplay = pair.isTriple ? `ç¬¬ ${index + 1} çµ„ (ä¸‰äºº) ğŸ° å‹•ç•«ä¸­...` : `ç¬¬ ${index + 1} çµ„ ğŸ° å‹•ç•«ä¸­...`;
          statusBadge = 'ğŸ¬ æ­æ›‰ä¸­';
          statusClass = 'status-revealing';
        } else {
          pairDisplay = pair.isTriple ? `ç¬¬ ${index + 1} çµ„ (ä¸‰äºº)` : `ç¬¬ ${index + 1} çµ„`;
        }
        return `
          <li class="pair-item ${itemClass}">
            <span class="pair-names">${pairDisplay}</span>
            <span class="status-badge ${statusClass}">
              ${statusBadge}
            </span>
          </li>
        `;
      }).join('');
    }

    async function handleStartPairing() {
      if (!confirm('ç¢ºå®šè¦é–‹å§‹é…å°å—ï¼Ÿé€™å°‡éš¨æ©Ÿåˆ†é…é…å°çµ„åˆã€‚')) {
        return;
      }

      try {
        startPairingBtn.disabled = true;
        startPairingBtn.textContent = 'é…å°ä¸­...';

        await performPairing();
        showToast('é…å°å®Œæˆï¼');
      } catch (error) {
        console.error(error);
        showToast(error.message || 'é…å°å¤±æ•—');
      } finally {
        startPairingBtn.disabled = false;
        startPairingBtn.textContent = 'ğŸ² é–‹å§‹é…å°';
      }
    }

    async function handleRevealNext() {
      try {
        revealNextBtn.disabled = true;

        const pair = await revealNextPair();

        if (pair) {
          if (pair.isTriple) {
            showToast(`æ­æ›‰ï¼š${pair.person1Name} â†” ${pair.person2Name} â†” ${pair.person3Name}`);
          } else {
            showToast(`æ­æ›‰ï¼š${pair.person1Name} â†” ${pair.person2Name}`);
          }
        } else {
          showToast('æ‰€æœ‰é…å°å·²æ­æ›‰å®Œç•¢ï¼');
        }
      } catch (error) {
        console.error(error);
        showToast('æ­æ›‰å¤±æ•—');
      } finally {
        revealNextBtn.disabled = false;
      }
    }

    async function handleReset() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®é…å°å—ï¼Ÿæ‰€æœ‰é…å°çµæœå°‡è¢«æ¸…é™¤ã€‚')) {
        return;
      }

      try {
        await resetGame();
        showToast('å·²é‡ç½®');
      } catch (error) {
        console.error(error);
        showToast('é‡ç½®å¤±æ•—');
      }
    }

    // === å·¥å…·å‡½å¼ ===
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === å‹•ç•«è¨­å®š ===
    const rollCountInput = document.getElementById('roll-count');
    const revealDelayInput = document.getElementById('reveal-delay');
    const saveSettingsBtn = document.getElementById('save-settings-btn');

    function loadSettings() {
      const rollCount = localStorage.getItem('rollCount') || '15';
      const revealDelay = localStorage.getItem('revealDelay') || '1';
      rollCountInput.value = rollCount;
      revealDelayInput.value = revealDelay;

      // åŒæ­¥åˆ° Firebase
      database.ref('settings').update({
        rollCount: parseInt(rollCount),
        revealDelay: parseFloat(revealDelay)
      });
    }

    async function saveSettings() {
      const rollCount = parseInt(rollCountInput.value) || 15;
      const revealDelay = parseFloat(revealDelayInput.value) || 1;

      localStorage.setItem('rollCount', rollCount);
      localStorage.setItem('revealDelay', revealDelay);

      // åŒæ­¥åˆ° Firebase çµ¦è§€çœ¾ç«¯ä½¿ç”¨
      await database.ref('settings').update({
        rollCount: rollCount,
        revealDelay: revealDelay
      });

      showToast('è¨­å®šå·²å„²å­˜');
    }

    // === åˆå§‹åŒ– ===
    function initAdmin() {
      // ç›£è½åƒèˆ‡è€…è®ŠåŒ–
      onParticipantsChange(renderParticipants);

      // ç›£è½éŠæˆ²ç‹€æ…‹è®ŠåŒ–
      onGameStateChange(updateStatusDisplay);

      // ç›£è½é…å°è®ŠåŒ–
      onPairsChange(renderPairs);

      // è¼‰å…¥è¨­å®š
      loadSettings();
    }

    // === äº‹ä»¶ç¶å®š ===
    document.addEventListener('DOMContentLoaded', function() {
      // é›ªèŠ±æ•ˆæœ
      createSnowflakes();

      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      checkSession();

      // ç™»å…¥äº‹ä»¶
      loginBtn.addEventListener('click', login);
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });

      // ç™»å‡ºäº‹ä»¶
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });

      // åƒèˆ‡è€…ç®¡ç†
      addParticipantBtn.addEventListener('click', handleAddParticipant);
      newParticipantInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddParticipant();
      });

      // é…å°æ§åˆ¶
      startPairingBtn.addEventListener('click', handleStartPairing);
      revealNextBtn.addEventListener('click', handleRevealNext);
      resetBtn.addEventListener('click', handleReset);

      // å‹•ç•«è¨­å®š
      saveSettingsBtn.addEventListener('click', saveSettings);
    });
  </script>
</body>
</html>
